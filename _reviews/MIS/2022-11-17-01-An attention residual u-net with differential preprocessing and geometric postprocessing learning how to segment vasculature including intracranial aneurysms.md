---
title: "[Review] An attention residual u-net with differential preprocessing and geometric postprocessing: learning how to segment vasculature including intracranial aneurysms"
collection: "论文评论"
category: "医学图像分割"
permalink: /reviews/2025-05-07-post-an-attention-residual-u-net-with-differential-preprocessing-and-geometric-postprocessing
publish_venue: "Medical Image Analysis (MIA)"
publish_date: 2022-11-17
write_venue: "理想家园, 南昌"
write_date: 2025-05-07
---

# [Review] An attention residual u-net with differential preprocessing and geometric postprocessing: learning how to segment vasculature including intracranial aneurysms

本文提出了一种使用边缘强化预处理、注意力门控和长短跳跃连接聚合特征的ARU-Net网络、3D条件随机场和连通域优化后处理的综合性分割方法。此方法是一项领域特定优化（针对计算血流动力学分析），它在DICE等传统指标上没有主流模型高，但ARU-Net对小血管和管壁细节保留效果更好，在计算血流动力学分析时不易失效，且与人工标注取得的血流动力学指标相关性更高。

# 收录

MIA 2023

Mu N, Lyu Z, Rezaeitaleshmahalleh M, et al. An attention residual u-net with differential preprocessing and geometric postprocessing: Learning how to segment vasculature including intracranial aneurysms[J]. Medical image analysis, 2023, 84: 102697.

[[paper]](https://doi.org/10.1016/j.media.2022.102697) [[paper(own)]](/files/reviews/ARU-Net/An%20attention%20residual%20u-net%20with%20differential%20preprocessing%20and%20geometric%20postprocessing%20learning%20how%20to%20segment%20vasculature%20including%20intracranial%20aneurysms.pdf)

# 要点

分割对象：Intracranial aneurysms (IA) 颅内动脉瘤。

创新点：
-  模态：3D rotational angiography (3DRA) images 3D旋转造影。
-  架构创新：attention residual U-Net (ARU-Net) 注意力门控残差UNet。
-  预处理：differential preprocessing 一种可微分的边缘强化预处理。
-  后处理：geometric postprocessing 3D条件随机场和CRF&连通域优化CCO后处理。

这是一项领域特定优化：DICE等传统指标没有主流模型高，但ARU-Net对小血管和管壁细节保留效果更好，在计算血流动力学分析时不易失效，且与人工标注取得的血流动力学指标相关性更高。


# 研究理由

## 难点

图像本身的问题：

- blurred boundaries 模糊边界。
- complex structure of  IAs 颅内动脉瘤的复杂结构。
- overlapping with brain tissue or other cerebral arteries 与脑组织或其它脑动脉的重叠。

现有深度学习模型的问题：这些问题会导致计算血流动力学分析出现严重错误。

- patch-based deep-learning segmentation networks operate on many small divided patches with a limited field of view (FOV), resulting in global and contextual information loss. This shortcoming may lead to an incomplete aneurysm structure and the omission of smaller vessels 基于切片学习的网络视野受限，导致全局和上下文信息丢失。见图c黄色箭头，欠分割，不完整的动脉瘤或丢失小血管。此问题并未得到实质性解决，只是采用了更充分的信息聚合方式。
- feature maps of different (spatial) resolutions/scales generated by the encoder-decoder network have large semantic gaps. Hence, prediction derived mostly from the deepest feature layer with weak semantic information will inevitably result in a loss of details (a dented IA sac 凹陷的IA囊 and a missing small artery 丢失的小动脉) 多尺度特征图之间有巨大的语义差距，大多基于深层特征图的预测会导致细节丢失，见图c的两个框。论文采用注意力门控方式弥合此差距。

- When convolutions are applied to a receptive region belonging to different vessels but containing similar intensity values, spatial context post-convolutions may further amplify the neighborhood dependencies, causing unwanted adhesions/connections between neighboring vessels 卷积用于包含不同血管的感受区域时，如果这些血管有相似的强度值，后（模型架构中靠后的，解码阶段）空域卷积可能过度放大邻近依赖导致预测出异常的邻近血管粘连（图d蓝色箭头）。通过3DCRF条件随机场后处理缓解此问题。

  ![image-20250507093757939](/images/reviews/An%20attention%20residual%20u-net%20with%20differential%20preprocessing%20and%20geometric%20postprocessing%20learning%20how%20to%20segment%20vasculature%20including%20intracranial%20aneurysms/vessel_connection_error.jpg)

## 意义

- 最终目标：对低/高破裂风险的动脉瘤进行鉴别，以便只对高破裂风险动脉瘤进行立即干预。
- 实用目标：computational hemodynamics（计算血流动力学分析，又称computational fluid dynamics [CFD]）requires an anatomically（解剖学） accurate vasculature model with the following characteristics: 1) water-tight, 2) includes all essential arteries, and 3) exhibits correct vessel connections 要求提供解剖结构精确的脉管系统模型，重要的是3)显示正确的血管连接。如图所示，3DUnet和nnU-Net基线都产生了错误的连接预测。目标情景对异常结构敏感性高，因此可以牺牲常规性能（例如DICE等）力求CFD可靠。

# 主要内容

## 方法概述

- preprocess: boundary enhancement to capture more contour information and enhance the presence of small vessels 预处理：边界增强提取边界信息和强化小血管。
- arch: long skip connections of the attention gate at each layer of the fully convolutional decoder-encoder structure to emphasize the field of view (FOV) 架构：使用带长连接的注意力门控来突出视野范围（FOV指每个切片）。
- arch: residual-based short skip connections were also embedded in each layer to implement in-depth supervision to help the network converge 架构：残差短连接用于实现深监督。
- supervision: multiscale supervision strategy for independent prediction at different levels of the decoding path, integrating multiscale semantic information to facilitate the segmentation of small vessels 监督：多尺度监督策略，汇集多尺度语义信息来帮助分割小血管。
- postprocess: the 3D conditional random field (3DCRF) and 3D connected component optimization (3DCCO) were exploited as postprocessing to optimize the segmentation results 后处理：使用条件随机场3DCRF和连通域优化3DCCO（即保留最大连通域）来优化分割结果。

## 预处理

对图像做标准化，并使用Sobel算子提取边缘，然后将两者加权合并为一张图像输入。与Boundary-Guided方法有别，本文未采用在模型中添加专用边界分支和边界损失监督的方法。

## 架构修改

![ARU-Net](/images/reviews/An%20attention%20residual%20u-net%20with%20differential%20preprocessing%20and%20geometric%20postprocessing%20learning%20how%20to%20segment%20vasculature%20including%20intracranial%20aneurysms/ARU-Net.png)

编码器每级和解码器每级都使用短连接。

编解码器之间的长连接通过注意力门控Attention Gate (AG)融合，AG接收编码器输出特征图f和下级解码器输出特征图g，通过卷积激活生成逐点注意力，与f特征图相乘后输出。这种方法有效抑制了特征图中的网格状伪影。

输出端使用所有解码器级的输出，采样和Sigmoid激活后加和作为分割结果。这一做法是比较独特的，一般模型都只使用最上级输出作为分割结果（下级结果可能仅仅用于深监督）。

使用Tversky损失函数，这是一种能够调节假阴性（FN）和假阳性（FP）监督权重的损失函数，论文更强调降低FN，其目的是避免忽略小血管，因为它们对血流动力学分析CFD至关重要。

## 后处理

3D conditional random field (3DCRF) 用于减少分割结果中邻近血管粘连的问题。邻近血管粘连是指两条血管离得很近，分割模型容易将其中缝隙也判断为前景。

3D connected component optimization (3DCCO) 用于抑制碎片式的小连通域。实际上就是只保留最大连通域。

# 实验和结论

在DICE、SEN、SPE、HD95、ASSD等传统指标上大多不如3DUNet、nnU-Net等主流模型，预处理用在3DUNet上反而降低性能，作者声称这种边缘强化预处理需要和注意力门控相结合才有用。

在计算血流动力学分析CFD的血流动力指标上取得了与人工标注最高的Pearson correlation coefficient相关系数0.9121，说明这是一项针对特定应用任务的有效优化。

# 讨论

## 全局和上下文信息聚合程度的上限？

3D图像规格太大，因此目前基本都使用切片学习，这将网络视野强制限定在一个切片内，其聚合范围不可能超过一个切片。因此如何实现跨切片的信息聚合是一个可探究的方向，例如或许可以采取保存特征图，编解码器分开训练的模式。

## 对一个体素进行分类究竟需要多少信息，长距离信息究竟是优势还是干扰？

这依然是个悬而未决的问题，自从ViT以来就一直在强调长距离建模的好处，但似乎并不是所有体素的分类都需要利用长距离信息，多层卷积的感受野其实已足以覆盖用于分类的依据信息，ViT可能反而容易摄之过多而导致难以训练或引入噪声。因此，可沿用ResNet类似的想法，以卷积为保底（相当于直通的跳跃连接），而ViT作为辅助路径。

ViT还有一个问题是，由于存储限制，通常将每16x16x16的切片作为一个Patch-Token，将它们拉成一维，做自注意力聚合，再重构为Patch规格。其中的问题是，每个Patch在空间信息上不是对齐的，但Token却是直接相互加权求和的。除非高级语义已经充分“传播”到每个体素，否则在Token间相互加权求和实际上会导致细粒度体素特征信息的传递混乱，有可能对那些原本已经足够进行分类判别的局部特征判据带来破坏性的干扰。
